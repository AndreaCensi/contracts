%YAML 1.1
---
version: '2'
workflows:
  version: 2
  test:
    jobs:
    - test-3.7-stage:
        context: z7-stage
        filters:
          branches:
            only: /z7-stage.*/
    - test-3.7-prod:
        context: z7-prod
        filters:
          branches:
            ignore: /z7-stage.*/
    - test-3.8-stage:
        context: z7-stage
        filters:
          branches:
            only: /z7-stage.*/
    - test-3.8-prod:
        context: z7-prod
        filters:
          branches:
            ignore: /z7-stage.*/
    - test-3.9-stage:
        context: z7-stage
        filters:
          branches:
            only: /z7-stage.*/
    - test-3.9-prod:
        context: z7-prod
        filters:
          branches:
            ignore: /z7-stage.*/
jobs:
  test-3.7-stage:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: contracts
      TEST_PACKAGES: contracts
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.7:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi


    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: contracts
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-contracts-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              contracts
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml


    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.7-prod:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: contracts
      TEST_PACKAGES: contracts
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.7:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi


    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: contracts
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-contracts-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              contracts
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml


    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.8-stage:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: contracts
      TEST_PACKAGES: contracts
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.8:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi


    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: contracts
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-contracts-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              contracts
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml


    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.8-prod:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: contracts
      TEST_PACKAGES: contracts
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.8:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi


    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: contracts
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-contracts-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              contracts
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml


    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.9-stage:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: contracts
      TEST_PACKAGES: contracts
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.9:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi


    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: contracts
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-contracts-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              contracts
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml


    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.9-prod:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: contracts
      TEST_PACKAGES: contracts
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.9:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi


    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: contracts
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-contracts-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              contracts
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml


    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium

# sigil dd25872aa86a6e3853e08323a65c2090
